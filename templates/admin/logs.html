<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>操作日志 - 客户关系管理系统</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <link rel="stylesheet" href="/static/css/admin.css">
    <style>
        .page-container {
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e6e6e6;
        }
        .page-header h2 {
            margin: 0;
            color: #333;
            font-size: 24px;
            font-weight: 600;
        }
        .search-card {
            margin-bottom: 20px;
        }
        .table-card {
            margin-bottom: 20px;
        }
        .pagination-container {
            margin-top: 20px;
            text-align: center;
        }
        .log-detail {
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div id="app">
        <admin-layout :active-menu="activeMenu">
            <template #content>
                <div class="page-container">
                    <div class="page-header">
                        <h2>操作日志</h2>
                        <div class="page-actions">
                            <el-button type="primary" icon="el-icon-refresh" @click="reload">刷新</el-button>
                        </div>
                    </div>

                    <el-card class="search-card">
                        <el-form :inline="true" :model="searchForm" class="search-form">
                            <el-form-item label="用户名">
                                <el-input v-model="searchForm.username" placeholder="请输入用户名" clearable @keyup.enter.native="handleSearch"></el-input>
                            </el-form-item>
                            <el-form-item label="模块">
                                <el-input v-model="searchForm.module" placeholder="如：用户管理/公告" clearable @keyup.enter.native="handleSearch"></el-input>
                            </el-form-item>
                            <el-form-item label="操作">
                                <el-input v-model="searchForm.action" placeholder="如：登录/新增" clearable @keyup.enter.native="handleSearch"></el-input>
                            </el-form-item>
                            <el-form-item label="状态">
                                <el-select v-model="searchForm.status" placeholder="请选择状态" clearable>
                                    <el-option label="全部" value=""></el-option>
                                    <el-option label="成功" :value="1"></el-option>
                                    <el-option label="失败" :value="0"></el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item label="关键词">
                                <el-input v-model="searchForm.keyword" placeholder="搜索详情或路径" clearable @keyup.enter.native="handleSearch"></el-input>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" @click="handleSearch">
                                    <i class="el-icon-search"></i> 搜索
                                </el-button>
                                <el-button @click="handleReset">
                                    <i class="el-icon-refresh"></i> 重置
                                </el-button>
                            </el-form-item>
                        </el-form>
                    </el-card>

                    <el-card class="table-card">
                        <el-table
                            :data="tableData"
                            v-loading="loading"
                            stripe
                            style="width: 100%">
                            <el-table-column prop="id" label="ID" width="80" align="center"></el-table-column>
                            <el-table-column prop="username" label="用户名" width="140" show-overflow-tooltip></el-table-column>
                            <el-table-column prop="module" label="模块" width="140" show-overflow-tooltip></el-table-column>
                            <el-table-column prop="action" label="操作" width="120"></el-table-column>
                            <el-table-column prop="detail" label="详情" min-width="240" show-overflow-tooltip>
                                <template slot-scope="scope">
                                    <span class="log-detail">{{ scope.row.detail || '-' }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column prop="status" label="状态" width="100" align="center">
                                <template slot-scope="scope">
                                    <el-tag :type="scope.row.status === 1 ? 'success' : 'danger'" size="small">
                                        {{ scope.row.status === 1 ? '成功' : '失败' }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="requestMethod" label="方法" width="90" align="center"></el-table-column>
                            <el-table-column prop="requestPath" label="路径" min-width="200" show-overflow-tooltip></el-table-column>
                            <el-table-column prop="ip" label="IP" width="140"></el-table-column>
                            <el-table-column prop="createTime" label="时间" width="180"></el-table-column>
                        </el-table>

                        <div class="pagination-container">
                            <el-pagination
                                @size-change="handleSizeChange"
                                @current-change="handleCurrentChange"
                                :current-page="pagination.pageNum"
                                :page-sizes="[10, 20, 50, 100]"
                                :page-size="pagination.pageSize"
                                layout="total, sizes, prev, pager, next, jumper"
                                :total="pagination.total">
                            </el-pagination>
                        </div>
                    </el-card>
                </div>
            </template>
        </admin-layout>
    </div>

    <script src="/static/js/vue.js"></script>
    <script src="/static/js/element-ui.min.js"></script>
    <script src="/static/js/axios.min.js"></script>
    <script src="/static/js/config/layout-config.js"></script>
    <script src="/static/js/components/layout.js"></script>
    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    activeMenu: 'logs',
                    loading: false,
                    tableData: [],
                    searchForm: {
                        username: '',
                        module: '',
                        action: '',
                        status: '',
                        keyword: ''
                    },
                    pagination: {
                        pageNum: 1,
                        pageSize: 10,
                        total: 0
                    }
                }
            },
            mounted() {
                this.loadData();
            },
            methods: {
                loadData() {
                    this.loading = true;
                    const params = {
                        pageNum: this.pagination.pageNum,
                        pageSize: this.pagination.pageSize,
                        username: this.searchForm.username,
                        module: this.searchForm.module,
                        action: this.searchForm.action,
                        status: this.searchForm.status,
                        keyword: this.searchForm.keyword
                    };

                    axios.get('/api/log/admin/list', { params })
                        .then(res => {
                            if (res.data.code === 200) {
                                this.tableData = res.data.data.rows;
                                this.pagination.total = res.data.data.total;
                            } else {
                                this.$message.error(res.data.message || '加载失败');
                            }
                        })
                        .catch(() => {
                            this.$message.error('加载失败');
                        })
                        .finally(() => {
                            this.loading = false;
                        });
                },
                handleSearch() {
                    this.pagination.pageNum = 1;
                    this.loadData();
                },
                handleReset() {
                    this.searchForm = {
                        username: '',
                        module: '',
                        action: '',
                        status: '',
                        keyword: ''
                    };
                    this.pagination.pageNum = 1;
                    this.loadData();
                },
                handleSizeChange(val) {
                    this.pagination.pageSize = val;
                    this.pagination.pageNum = 1;
                    this.loadData();
                },
                handleCurrentChange(val) {
                    this.pagination.pageNum = val;
                    this.loadData();
                },
                reload() {
                    this.loadData();
                }
            }
        });
    </script>
</body>
</html>

